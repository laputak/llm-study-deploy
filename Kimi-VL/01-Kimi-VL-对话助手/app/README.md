# Kimi-VL 多模态对话助手

这是一个基于Moonshot AI的Kimi-VL-A3B-Thinking多模态模型的前后端分离应用，提供了一个简单的网页界面来与模型进行对话。支持同时上传图片和文本，让模型可以理解和分析图像内容。

## 特点

- 支持多模态输入，可以同时处理文本和图像
- 图像自动压缩和优化，确保上传稳定性
- 可视化思考过程，展示模型分析推理的步骤（◁think▷标签）
- 支持一次上传多张图片（最多2张）
- 应用启动时预加载模型，避免每次请求都重新加载
- 模型加载状态显示，用户可以直观地了解模型加载进度
- 支持多轮对话，自动保存对话历史记录
- 可以清除对话历史，开始新的对话
- 可通过滑动条实时调整生成文本长度和历史记录长度
- 简洁美观的聊天界面
- 响应式设计，适配不同尺寸的屏幕
- 健壮的错误处理和用户反馈

## 安装依赖

```bash
pip install -r requirements.txt
```

## 运行应用

```bash
python app.py
```

应用将在 http://localhost:5000 上运行。

**注意**：启动后模型会在后台自动加载，这可能需要1-2分钟。在此期间，界面会显示"模型正在加载中"的提示，加载完成后才能开始对话。

## 使用方法

1. 在浏览器中打开 http://localhost:5000
2. 等待模型加载完成（顶部的橙色通知条消失）
3. 根据需要调整参数滑动条：
   - **生成长度上限**：控制每次回复生成的最大token数（范围：256-2048）
   - **历史记录长度**：控制对话中保留的最大轮数（范围：2-20）
4. 使用多模态功能：
   - 点击"上传图片"按钮选择图片（支持JPG、PNG等常见格式）
   - 可以一次上传最多2张图片
   - 在输入框中输入文本问题（例如："请描述这个图片中的内容"）
   - 也可以不上传图片，仅使用文本进行对话
5. 点击"发送"按钮或按Enter键发送问题
6. 等待模型生成回复（处理图像可能需要更长时间）
7. 查看分析过程：
   - 如果回复包含"查看思考过程"链接，可以点击查看模型的详细分析步骤
8. 继续进行多轮对话，模型会记住之前的对话内容
9. 如需清除对话历史，点击"清除对话历史"按钮

## 多模态功能说明

本应用支持多模态输入，结合文本和图像的分析能力：

- **图像上传**：点击"上传图片"按钮选择本地图片文件
- **图像预览**：上传后可以在发送前预览图片，点击图片右上角的"×"可以移除图片
- **图像压缩**：系统会自动压缩大尺寸图片，以确保传输稳定性和响应速度
- **多张图片**：支持同时上传最多2张图片，让模型可以比较或分析多个图像
- **思考过程**：对于复杂的图像分析，模型会显示详细的思考过程（标记为◁think▷），展示分析步骤

## 调整模型参数

应用提供了实时调整模型参数的功能：

- **模型生成长度上限 (max_new_tokens)**：控制模型每次生成的最大token数。较大的值可以让模型生成更长的回复，但会增加生成时间和资源消耗。
- **最大对话记忆轮数 (max_history_length)**：控制在对话中保留的最大轮数。较大的值可以让模型记住更多的上下文，但会增加输入长度和资源消耗。

通过滑动条调整的参数会立即生效，并应用于下一次对话中。

## 技术实现

- 使用Flask作为Web框架
- 基于Moonshot AI的Kimi-VL-A3B-Thinking多模态模型
- 使用AutoProcessor处理图像和文本的多模态输入
- 前端使用Canvas进行图像压缩和优化
- 应用启动时在单独的线程中加载模型，避免阻塞主线程
- 服务器端和客户端图像处理双重优化，保证大图片也能顺利上传
- 使用全局变量存储预加载的模型和tokenizer
- 使用服务器端会话管理对话历史记录
- 每个会话分配唯一的UUID，支持多用户同时使用
- 对话历史保留最近的多轮对话，防止上下文过长
- 每次请求后清理GPU缓存，减少内存占用
- 前端通过定期轮询检查模型加载状态
- 使用HTML滑动条组件实时调整模型参数
- 细致的错误处理和日志记录，便于排查问题

## 注意事项

- 确保服务器有足够的GPU显存来运行该模型
- 图片上传大小限制为10MB，超过此限制的图片将被拒绝上传
- 系统会自动压缩大尺寸图片，但过大的图片可能影响性能
- 默认生成限制为1024个token，可以通过界面滑动条调整（范围：256-2048）
- 默认保留最近10轮对话历史，可以通过界面滑动条调整（范围：2-20）
- 启用了torch.no_grad()以减少内存使用
- 处理图像时的请求超时时间为120秒，如果响应时间过长，请尝试上传较小的图片

## 示例问题

使用本多模态模型时，您可以尝试以下类型的问题：

1. **图像描述**："请详细描述这张图片中的内容"
2. **视觉分析**："这张图片中有哪些物体？它们各自的特点是什么？"
3. **图像比较**：[上传两张图] "比较这两张图片的异同点"
4. **内容识别**："图片中的文字内容是什么？"
5. **场景理解**："这个场景可能是在什么地方？为什么？"
6. **情感分析**："图片中人物的情绪如何？基于什么判断？"
7. **视觉推理**："根据图片内容，推测这可能是什么场合或事件？" 